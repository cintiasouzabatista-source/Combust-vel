<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle CombustÃ­vel - Ford Fiesta</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#0f172a;
  color:white;
  margin:0;
  padding:20px;
}
h1{margin-bottom:20px}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:15px;
  margin-bottom:20px;
}
.card{
  background:#1e293b;
  padding:15px;
  border-radius:12px;
}
input,select,button{
  width:100%;
  padding:8px;
  margin-top:8px;
  border-radius:8px;
  border:none;
}
button{
  background:#2563eb;
  color:white;
  cursor:pointer;
}
small{color:#94a3b8}
video{border-radius:12px}
</style>
</head>

<body>

<h1>ðŸš— Controle CombustÃ­vel - Ford Fiesta</h1>

<div class="grid">
  <div class="card">
    <h3>Km/L Gasolina</h3>
    <div id="kmlGas">-</div>
  </div>
  <div class="card">
    <h3>Km/L Etanol</h3>
    <div id="kmlEta">-</div>
  </div>
  <div class="card">
    <h3>Gasto no mÃªs</h3>
    <div id="gastoMes">-</div>
  </div>
  <div class="card">
    <h3>Autonomia estimada</h3>
    <div id="autonomia">-</div>
  </div>
</div>

<div class="card">
<h3>Nota fiscal (NFC-e)</h3>

<button onclick="toggleScanner()">ðŸ“· Ler QR da NFC-e</button>
<video id="qrVideo" style="display:none;width:100%;margin-top:10px" playsinline></video>

<input id="nfceUrl" placeholder="Cole aqui o link da NFC-e" />
<button onclick="lerNfce()">Ler NFC-e</button>

<small id="nfceStatus">â€”</small>
</div>

<div class="card">
<h3>Novo abastecimento</h3>

<input type="date" id="data">
<input type="number" id="odometro" placeholder="OdÃ´metro (km)">
<input type="number" id="litros" placeholder="Litros">
<input type="number" id="valor" placeholder="Valor (R$)">
<select id="tipo">
  <option>Gasolina</option>
  <option>Etanol</option>
</select>

<button onclick="salvar()">Salvar</button>
</div>

<script>

let abastecimentos = JSON.parse(localStorage.getItem("abastecimentos")||"[]");

function salvar(){
  const item = {
    data:document.getElementById("data").value,
    odometro:Number(document.getElementById("odometro").value),
    litros:Number(document.getElementById("litros").value),
    valor:Number(document.getElementById("valor").value),
    tipo:document.getElementById("tipo").value
  };
  abastecimentos.push(item);
  localStorage.setItem("abastecimentos",JSON.stringify(abastecimentos));
  atualizar();
}

function atualizar(){
  if(abastecimentos.length<2)return;

  let gas=[],eta=[];
  for(let i=1;i<abastecimentos.length;i++){
    let atual=abastecimentos[i];
    let anterior=abastecimentos[i-1];
    let km=atual.odometro-anterior.odometro;
    let consumo=km/atual.litros;
    if(atual.tipo==="Gasolina")gas.push(consumo);
    else eta.push(consumo);
  }

  const media=(arr)=>arr.length?(arr.reduce((a,b)=>a+b)/arr.length).toFixed(2):"-";

  document.getElementById("kmlGas").innerText=media(gas);
  document.getElementById("kmlEta").innerText=media(eta);

  const mesAtual=new Date().getMonth();
  let gasto=abastecimentos
    .filter(a=>new Date(a.data).getMonth()===mesAtual)
    .reduce((s,a)=>s+a.valor,0);

  document.getElementById("gastoMes").innerText="R$ "+gasto.toFixed(2);

  if(gas.length){
    document.getElementById("autonomia").innerText=(media(gas)*52).toFixed(0)+" km";
  }
}

function setStatus(msg){
  document.getElementById("nfceStatus").innerText=msg;
}

function preencherCampos(n){
  if(n.dataHora){
    const d=n.dataHora.split(" ")[0];
    const [dd,mm,aaaa]=d.split("/");
    document.getElementById("data").value=`${aaaa}-${mm}-${dd}`;
  }
  if(n.litros)document.getElementById("litros").value=n.litros;
  if(n.valor)document.getElementById("valor").value=n.valor;
  if(n.tipo)document.getElementById("tipo").value=n.tipo;
}

async function lerNfce(){
  const url=document.getElementById("nfceUrl").value.trim();
  if(!url){setStatus("Cole o link.");return;}
  setStatus("Lendo NFC-e...");

  const r=await fetch("/api/nfce?url="+encodeURIComponent(url));
  const j=await r.json();

  if(!j.ok){setStatus("Erro.");return;}

  preencherCampos(j.normalized);
  setStatus("OK âœ” Dados preenchidos.");
}

let qrStream=null;

async function toggleScanner(){
  const video=document.getElementById("qrVideo");

  if(qrStream){
    qrStream.getTracks().forEach(t=>t.stop());
    qrStream=null;
    video.style.display="none";
    return;
  }

  try{
    qrStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject=qrStream;
    await video.play();
    video.style.display="block";

    if(!("BarcodeDetector" in window)){
      setStatus("QR nÃ£o suportado neste navegador.");
      return;
    }

    const detector=new BarcodeDetector({formats:["qr_code"]});

    const scan=async()=>{
      if(!qrStream)return;
      const codes=await detector.detect(video);
      if(codes.length){
        const raw=codes[0].rawValue;
        document.getElementById("nfceUrl").value=raw;
        qrStream.getTracks().forEach(t=>t.stop());
        qrStream=null;
        video.style.display="none";
        lerNfce();
        return;
      }
      requestAnimationFrame(scan);
    };
    scan();
  }catch(e){
    setStatus("Erro cÃ¢mera.");
  }
}

atualizar();

</script>

</body>
</html>
