<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Painel Combust√≠vel</title>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#06101f;
      --bg2:#071225;
      --panel:rgba(255,255,255,.04);
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --text:#eaf1ff;
      --muted:rgba(234,241,255,.70);
      --accent:#2b6dff;
      --accent2:#1f55cc;
      --danger:#ff476f;
      --ok:#29d17c;
      --shadow:0 14px 34px rgba(0,0,0,.28);
      --radius:18px;
      --line:rgba(255,255,255,.08);
      --sideW: 280px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 900px at 10% 0%, #0a1c38 0%, var(--bg) 45%, #050c17 100%);
      overflow-x:hidden;
    }
    a{color:#bcd0ff}
    .app{
      min-height:100vh;
      display:flex;
    }

    /* Sidebar */
    .sidebar{
      width:var(--sideW);
      background:rgba(5,12,23,.86);
      border-right:1px solid var(--line);
      padding:14px 12px;
      position:fixed;
      top:0; bottom:0; left:0;
      transform: translateX(-102%);
      transition: transform .22s ease;
      z-index:2500;
      backdrop-filter: blur(14px);
    }
    .sidebar.open{ transform: translateX(0); }
    .sidebar .brand{
      display:flex; align-items:center; gap:10px;
      padding:10px 10px 14px;
      border-bottom:1px solid var(--line);
      margin-bottom:10px;
    }
    .brand .logo{font-size:22px}
    .brand .txt{display:flex; flex-direction:column}
    .brand .txt .t{font-size:14px; font-weight:900}
    .brand .txt .s{font-size:12px; color:var(--muted); font-weight:800}

    .nav{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:10px 6px;
    }
    .nav button{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      padding:12px 12px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      text-align:left;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .nav button.active{
      background:rgba(43,109,255,.16);
      border-color:rgba(43,109,255,.35);
      color:var(--text);
    }
    .nav .ic{width:22px; display:inline-flex; justify-content:center}
    .side-footer{
      position:absolute;
      left:12px; right:12px; bottom:12px;
      border-top:1px solid var(--line);
      padding-top:10px;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }

    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
      display:none;
      z-index:2400;
    }
    .overlay.show{display:block}

    /* Main */
    .main{
      width:100%;
      padding:16px 14px 28px;
      margin-left:0;
    }
    @media (min-width: 980px){
      .sidebar{ transform: translateX(0); position:sticky; z-index:1; }
      .overlay{display:none !important;}
      .main{ margin-left:0; padding-left:18px; }
      .topbar .menuBtn{ display:none; }
      .app{ gap:0; }
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .menuBtn{
      width:auto;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
    }
    .statusPill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--ok);box-shadow:0 0 0 3px rgba(41,209,124,.18)}
    h1{
      margin:0;
      font-size:24px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .subtitle{
      margin:6px 0 0;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }

    /* Sections */
    .section{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      margin:14px 0;
    }
    .sectionTitle{
      margin:0 0 10px;
      font-size:14px;
      font-weight:950;
    }
    .divider{
      height:1px;
      background:var(--line);
      margin:14px 0;
    }

    /* Cards */
    .cards{
      display:grid;
      grid-template-columns:1fr 1fr; /* 2 por linha j√° no celular */
      gap:12px;
    }
    @media (min-width: 980px){
      .cards{ grid-template-columns:repeat(4, 1fr); }
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px 14px;
      min-height:92px;
    }
    .card .label{
      margin:0;
      color:var(--muted);
      font-size:12px;
      font-weight:850;
    }
    .card .val{
      margin-top:10px;
      font-size:22px;
      font-weight:950;
    }
    .small{
      margin-top:6px;
      color:rgba(234,241,255,.55);
      font-size:12px;
      font-weight:800;
    }

    /* Form */
    label{
      display:block;
      margin:10px 0 6px;
      color:rgba(234,241,255,.78);
      font-size:12px;
      font-weight:900;
    }
    input, select, button{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 12px;
      outline:none;
      font-weight:900;
      font-size:14px;
    }
    input::placeholder{ color:rgba(234,241,255,.45); font-weight:800; }
    input:focus, select:focus{ border-color:rgba(43,109,255,.55); box-shadow:0 0 0 4px rgba(43,109,255,.12); }

    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 420px){ .row{ grid-template-columns:1fr; } }

    .btn{
      background:linear-gradient(180deg, var(--accent), var(--accent2));
      border:1px solid rgba(255,255,255,.14);
      cursor:pointer;
      font-weight:950;
    }
    .btn.secondary{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
    }
    .btn.danger{
      background:rgba(255,71,111,.12);
      border-color:rgba(255,71,111,.30);
      color:#ffd7e0;
    }
    .btn:active{ transform: translateY(1px); }

    .hint{ color:var(--muted); font-size:12px; font-weight:800; margin:0 0 10px; }
    .statusLine{ color:rgba(234,241,255,.78); font-size:12px; font-weight:900; margin-top:10px; }

    /* Table */
    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    th, td{
      padding:10px 10px;
      text-align:left;
      font-size:12px;
      border-bottom:1px solid rgba(255,255,255,.07);
      vertical-align:top;
      font-weight:800;
    }
    th{ color:rgba(234,241,255,.70); font-weight:900; }
    tr:last-child td{ border-bottom:none; }

    /* Toast */
    #toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.76);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      font-weight:900;
      font-size:12px;
      display:none;
      z-index:4000;
      max-width:92vw;
      text-align:center;
    }
  
    /* Premium report cards */
    .reportGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (min-width: 980px){
      .reportGrid{
        grid-template-columns: 1fr 1fr;
        gap:14px;
      }
    }
    .reportCard{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.035));
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .reportCard:before{
      content:"";
      position:absolute;
      inset:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      pointer-events:none;
    }
    .reportHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:2px 2px 10px;
    }
    .reportTitle{
      font-size:13px;
      font-weight:950;
      color:rgba(234,241,255,.88);
      margin:0;
    }
    .reportSub{
      font-size:12px;
      font-weight:800;
      color:var(--muted);
      margin:0;
      text-align:right;
      white-space:nowrap;
    }
    .chartBox{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.07);
      border-radius:14px;
      padding:10px;
      height:220px; /* compacto */
    }
    @media (min-width: 980px){
      .chartBox{ height:240px; }
    }
    

  </style>
</head>

<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="logo">üöó</div>
      <div class="txt">
        <div class="t">Painel Combust√≠vel</div>
        <div class="s">focado no celular</div>
      </div>
    </div>

    <nav class="nav" aria-label="Menu">
      <button class="active" data-view="painel"><span class="ic">üè†</span><span>Painel</span></button>
      <button data-view="abastecer"><span class="ic">‚õΩ</span><span>Abastecer</span></button>
      <button data-view="historico"><span class="ic">üßæ</span><span>Hist√≥rico</span></button>
      <button data-view="relatorios"><span class="ic">üìä</span><span>Relat√≥rios</span></button>
      <button data-view="config"><span class="ic">‚öôÔ∏è</span><span>Configura√ß√µes</span></button>
    </nav>

    <div class="side-footer">
      Dica: NFC-e SP funciona melhor colando o link. QR pode depender do aparelho.
    </div>
  </aside>

  <div class="overlay" id="overlay"></div>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <button class="menuBtn" id="menuBtn">‚ò∞ Menu</button>
      <div>
        <h1 id="pageTitle">Painel</h1>
        <div class="subtitle" id="pageSub">Resumo r√°pido do consumo</div>
      </div>
      <div class="statusPill"><span class="dot"></span><span id="pillStatus">Pronto</span></div>
    </div>

    <!-- PAINEL -->
    <section class="section view" id="view-painel">
      <div class="cards">
        <div class="card">
          <div class="label">Km/L Gasolina</div>
          <div class="val" id="kmlGas">‚Äî</div>
          <div class="small">m√©dia (√∫ltimos)</div>
        </div>
        <div class="card">
          <div class="label">Km/L Etanol</div>
          <div class="val" id="kmlEta">‚Äî</div>
          <div class="small">m√©dia (√∫ltimos)</div>
        </div>
        <div class="card">
          <div class="label">Gasto no m√™s</div>
          <div class="val" id="gastoMes">R$ 0,00</div>
          <div class="small">m√™s atual</div>
        </div>
        <div class="card">
          <div class="label">Autonomia estimada</div>
          <div class="val" id="autonomia">‚Äî</div>
          <div class="small">estimativa simples</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="sectionTitle">üìÑ Nota fiscal (NFC-e)</div>
      <p class="hint">Cole o link da NFC-e (SP) e toque em ‚ÄúLer NFC-e e preencher‚Äù.</p>

      <div class="row">
        <button class="btn secondary" id="btnQrInfo" type="button">üì∑ Ler QR (dica)</button>
        <button class="btn" id="btnLerNfce" type="button">‚úÖ Ler NFC-e e preencher</button>
      </div>

      <label for="nfceUrl">Link da NFC-e</label>
      <input id="nfceUrl" placeholder="https://www.nfce.fazenda.sp.gov.br/...ConsultaQRCode.aspx?p=..." />

      <div class="row" style="margin-top:10px">
        <button class="btn secondary" id="btnUsarLink" type="button">üîó Usar link no lan√ßamento</button>
        <button class="btn secondary" id="btnAbrirLink" type="button">üåê Abrir consulta</button>
      </div>

      <div class="statusLine" id="nfceStatus">‚Äî</div>
    </section>

    <!-- ABASTECER -->
    <section class="section view" id="view-abastecer" style="display:none">
      <div class="sectionTitle">‚õΩ Novo abastecimento</div>
      <p class="hint">Para calcular Km/L: informe sempre o od√¥metro. O app usa a diferen√ßa para o abastecimento anterior do mesmo combust√≠vel.</p>

      <div class="row">
        <div>
          <label for="data">Data</label>
          <input id="data" type="date" />
        </div>
        <div>
          <label for="tipo">Combust√≠vel</label>
          <select id="tipo">
            <option value="Gasolina">Gasolina</option>
            <option value="Etanol">Etanol</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="odometro">Od√¥metro (km)</label>
          <input id="odometro" inputmode="numeric" placeholder="Ex: 84092" />
        </div>
        <div>
          <label for="litros">Litros</label>
          <input id="litros" inputmode="decimal" placeholder="Ex: 8,818" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="valor">Valor (R$)</label>
          <input id="valor" inputmode="decimal" placeholder="Ex: 50,00" />
        </div>
        <div>
          <label for="nfceLink">Link NFC-e (opcional)</label>
          <input id="nfceLink" placeholder="Fica salvo no hist√≥rico" />
        </div>
      </div>

      <label for="kmAntes">Km que o painel mostrava ANTES (opcional)</label>
      <input id="kmAntes" inputmode="numeric" placeholder="Ex: 18" />

      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnSalvar" type="button">Salvar</button>
        <button class="btn secondary" id="btnLimparForm" type="button">Limpar</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn danger" id="btnApagarTudo" type="button">üßπ Apagar tudo</button>
        <button class="btn secondary" id="btnExportarJson" type="button">‚¨áÔ∏è Exportar backup (JSON)</button>
      </div>

      <div class="statusLine" id="saveStatus">‚Äî</div>
    </section>

    <!-- HISTORICO -->
    <section class="section view" id="view-historico" style="display:none">
      <div class="sectionTitle">üßæ Hist√≥rico de consumo</div>
      <p class="hint">Toque no link da NFC-e para abrir quando quiser.</p>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Km</th>
              <th>Litros</th>
              <th>R$</th>
              <th>Tipo</th>
              <th>Km/L</th>
              <th>NFC-e</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="statusLine" id="histStatus">‚Äî</div>
    </section>

    <!-- RELATORIOS -->
    <section class="section view" id="view-relatorios" style="display:none">
      <div class="sectionTitle">üìä Relat√≥rios</div>
      <p class="hint">Consumo (Km/L) por abastecimento e gasto mensal.</p>
      <div class="divider"></div>

      <div class="reportGrid">
        <div class="reportCard">
          <div class="reportHead">
            <p class="reportTitle">Consumo (Km/L)</p>
            <p class="reportSub">linha</p>
          </div>
          <div class="chartBox">
            <canvas id="chartKml" height="220"></canvas>
          </div>
        </div>

        <div class="reportCard">
          <div class="reportHead">
            <p class="reportTitle">Gasto mensal (R$)</p>
            <p class="reportSub">barras</p>
          </div>
          <div class="chartBox">
            <canvas id="chartMes" height="220"></canvas>
          </div>
        </div>
      </div>
<div class="statusLine" id="relStatus">‚Äî</div>
    </section>

    <!-- CONFIG -->
    <section class="section view" id="view-config" style="display:none">
      <div class="sectionTitle">‚öôÔ∏è Configura√ß√µes</div>
      <p class="hint">Ajuste tanque e janela de m√©dia. A autonomia usa: (kmAntes informado) + (litros * m√©dia Km/L).</p>

      <div class="row">
        <div>
          <label for="tank">Capacidade do tanque (L)</label>
          <input id="tank" inputmode="decimal" placeholder="Ex: 52" />
        </div>
        <div>
          <label for="kmlWindow">M√©dia por quantos lan√ßamentos</label>
          <input id="kmlWindow" inputmode="numeric" placeholder="Ex: 6" />
        </div>
      </div>

      <button class="btn" id="btnSalvarCfg" type="button" style="margin-top:10px">Salvar configura√ß√µes</button>
      <div class="statusLine" id="cfgStatus">‚Äî</div>

      <div class="divider"></div>
      <div class="sectionTitle">‚ÑπÔ∏è Como a autonomia √© calculada</div>
      <p class="hint">
        O painel do carro pode variar muito (tr√¢nsito, estilo de dire√ß√£o). Aqui usamos uma estimativa simples:
        <br><br>
        <b>Autonomia ‚âà (km antes, se voc√™ informar) + (litros abastecidos √ó sua m√©dia Km/L)</b>.
        <br><br>
        Se voc√™ n√£o informar ‚Äúkm antes‚Äù, mostramos apenas <b>litros √ó m√©dia</b> do combust√≠vel.
      </p>
    </section>
  </main>
</div>

<div id="toast"></div>

<script>
/* =========================
   Storage
========================= */
const STORE_KEY = "cb_abastecimentos_v3";
const CFG_KEY   = "cb_cfg_v3";

const $ = (id)=>document.getElementById(id);

function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display="block";
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>{ t.style.display="none"; }, 2500);
}
function setPill(msg){ $("pillStatus").textContent = msg; }

function parseBRNumber(s){
  if(s === null || s === undefined) return null;
  const v = String(s).trim();
  if(!v) return null;
  const norm = v.replace(/\./g,"").replace(",", ".");
  const n = Number(norm);
  return Number.isFinite(n) ? n : null;
}
function formatBRL(n){
  const v = Number(n);
  if(!Number.isFinite(v)) return "R$ 0,00";
  return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}
function formatNum(n, digits=2){
  const v = Number(n);
  if(!Number.isFinite(v)) return "‚Äî";
  return v.toLocaleString("pt-BR",{minimumFractionDigits:digits, maximumFractionDigits:digits});
}
function formatInt(n){
  const v = Number(n);
  if(!Number.isFinite(v)) return "‚Äî";
  return Math.round(v).toLocaleString("pt-BR");
}
function ymFromDateISO(iso){
  const [y,m] = String(iso||"").split("-");
  if(!y || !m) return null;
  return `${y}-${m}`;
}
function ymLabel(ym){
  const [y,m] = ym.split("-");
  return `${m}/${y}`;
}

function loadItems(){
  try{ return JSON.parse(localStorage.getItem(STORE_KEY) || "[]"); }
  catch(e){ return []; }
}
function saveItems(items){ localStorage.setItem(STORE_KEY, JSON.stringify(items)); }

function loadCfg(){
  try{ return JSON.parse(localStorage.getItem(CFG_KEY) || "{}"); }
  catch(e){ return {}; }
}
function saveCfg(cfg){ localStorage.setItem(CFG_KEY, JSON.stringify(cfg)); }

let items = loadItems();
let cfg = Object.assign({ tank: 52, kmlWindow: 6 }, loadCfg());

/* =========================
   Menu / Views
========================= */
const views = ["painel","abastecer","historico","relatorios","config"];
function showView(name){
  for(const v of views){
    const el = document.getElementById("view-"+v);
    if(!el) continue;
    el.style.display = (v===name) ? "block" : "none";
  }
  // sidebar active
  document.querySelectorAll(".nav button").forEach(b=>{
    b.classList.toggle("active", b.dataset.view===name);
  });
  // title
  const titles = {
    painel: ["Painel","Resumo r√°pido do consumo"],
    abastecer: ["Abastecer","Novo abastecimento"],
    historico: ["Hist√≥rico","Seus lan√ßamentos"],
    relatorios: ["Relat√≥rios","Consumo e gasto mensal"],
    config: ["Configura√ß√µes","Ajustes do app"]
  };
  $("pageTitle").textContent = titles[name][0];
  $("pageSub").textContent = titles[name][1];

  // close mobile sidebar
  closeSidebar();

  // lazy render charts when open
  if(name==="relatorios") renderCharts();
}
function openSidebar(){
  $("sidebar").classList.add("open");
  $("overlay").classList.add("show");
}
function closeSidebar(){
  $("sidebar").classList.remove("open");
  $("overlay").classList.remove("show");
}
$("menuBtn").addEventListener("click", openSidebar);
$("overlay").addEventListener("click", closeSidebar);
document.querySelectorAll(".nav button").forEach(b=>{
  b.addEventListener("click", ()=>showView(b.dataset.view));
});
document.addEventListener("keydown", (e)=>{
  if(e.key==="Escape") closeSidebar();
});

/* =========================
   NFC-e (link)
========================= */
async function lerNfce(){
  const url = ($("nfceUrl").value || "").trim();
  if(!url){
    $("nfceStatus").textContent = "Cole o link da NFC-e primeiro.";
    toast("Cole o link da NFC-e.");
    return;
  }
  $("nfceStatus").textContent = "Lendo NFC-e‚Ä¶";
  setPill("Lendo NFC-e‚Ä¶");

  try{
    const r = await fetch(`/api/nfce?url=${encodeURIComponent(url)}`);
    const data = await r.json();

    if(!data.ok){
      $("nfceStatus").textContent = `Erro: ${data.error || "n√£o foi poss√≠vel ler"}`;
      setPill("Erro");
      toast("Erro ao ler NFC-e");
      return;
    }

    const n = data.normalized || {};
    if(n.dataHora){
      const d = n.dataHora.slice(0,10).split("/");
      if(d.length === 3) $("data").value = `${d[2]}-${d[1]}-${d[0]}`;
    }
    if(n.tipo) $("tipo").value = n.tipo;
    if(Number.isFinite(n.litros)) $("litros").value = String(n.litros).replace(".", ",");
    if(Number.isFinite(n.valor)) $("valor").value = String(n.valor).replace(".", ",");

    $("nfceLink").value = url;

    $("nfceStatus").textContent = "OK ‚úÖ Dados preenchidos. Agora informe o od√¥metro e salve.";
    setPill("Pronto");
    toast("Dados preenchidos ‚úÖ");
    // abre tela de abastecer
    showView("abastecer");
  }catch(e){
    $("nfceStatus").textContent = "Falha ao chamar /api/nfce. Confira se a API est√° no ar.";
    setPill("Falha");
    toast("Falha na API");
  }
}
function usarLinkNoLancamento(){
  const url = ($("nfceUrl").value || "").trim();
  if(!url){ toast("Cole o link da NFC-e primeiro."); return; }
  $("nfceLink").value = url;
  toast("Link colocado no lan√ßamento.");
}
function abrirLink(){
  const url = ($("nfceUrl").value || "").trim();
  if(!url){ toast("Cole o link da NFC-e."); return; }
  window.open(url, "_blank", "noopener");
}
$("btnLerNfce").addEventListener("click", lerNfce);
$("btnUsarLink").addEventListener("click", usarLinkNoLancamento);
$("btnAbrirLink").addEventListener("click", abrirLink);
$("btnQrInfo").addEventListener("click", ()=>{
  toast("No Xiaomi pode falhar. Use a c√¢mera/Lens para abrir o link e cole aqui.");
});

/* =========================
   Save abastecimento
========================= */
function sortItems(){
  // order by date then odometer
  items.sort((a,b)=>{
    const da = (a.data||"");
    const db = (b.data||"");
    if(da<db) return -1;
    if(da>db) return 1;
    return (Number(a.odometro)||0) - (Number(b.odometro)||0);
  });
}

function lastItemOfType(tipo, currentOdo){
  const filtered = items
    .filter(x => x.tipo===tipo && Number.isFinite(Number(x.odometro)) && Number(x.odometro) < currentOdo);
  if(filtered.length===0) return null;
  filtered.sort((a,b)=>Number(a.odometro)-Number(b.odometro));
  return filtered[filtered.length-1];
}

function computeKmlForEntry(tipo, odometro, litros){
  const odo = Number(odometro);
  const l = Number(litros);
  if(!Number.isFinite(odo) || !Number.isFinite(l) || l<=0) return null;

  const prev = lastItemOfType(tipo, odo);
  if(!prev) return null;

  const delta = odo - Number(prev.odometro);
  if(!Number.isFinite(delta) || delta<=0) return null;

  return { kml: delta / l, deltaKm: delta };
}

function avgKml(tipo){
  const w = Number(cfg.kmlWindow) || 6;
  const list = items
    .filter(x => x.tipo===tipo && Number.isFinite(Number(x.kml)))
    .sort((a,b)=> (a.data||"").localeCompare(b.data||""));
  const last = list.slice(-w);
  if(last.length===0) return null;
  const sum = last.reduce((acc,x)=>acc+Number(x.kml),0);
  return sum / last.length;
}

function estimateAutonomy(tipo, litros, kmAntes){
  const av = avgKml(tipo);
  if(!Number.isFinite(Number(litros)) || !(Number(litros)>0) || !Number.isFinite(av)) return null;
  const add = Number(litros) * av;
  const before = Number(kmAntes);
  if(Number.isFinite(before) && before>=0) return before + add;
  return add;
}

function saveForm(){
  const data = $("data").value;
  const tipo = $("tipo").value;
  const odometro = parseBRNumber($("odometro").value);
  const litros = parseBRNumber($("litros").value);
  const valor = parseBRNumber($("valor").value);
  const nfceLink = ($("nfceLink").value || "").trim();
  const kmAntes = parseBRNumber($("kmAntes").value);

  if(!data){ toast("Informe a data."); return; }
  if(!Number.isFinite(odometro)){ toast("Informe o od√¥metro."); return; }
  if(!Number.isFinite(litros) || litros<=0){ toast("Informe os litros."); return; }
  if(!Number.isFinite(valor) || valor<0){ toast("Informe o valor."); return; }

  const kmlObj = computeKmlForEntry(tipo, odometro, litros);
  const kml = kmlObj ? kmlObj.kml : null;
  const deltaKm = kmlObj ? kmlObj.deltaKm : null;

  const autonomiaEst = estimateAutonomy(tipo, litros, kmAntes);

  const item = {
    id: `${Date.now()}_${Math.random().toString(16).slice(2)}`,
    data, tipo,
    odometro, litros, valor,
    nfceLink: nfceLink || null,
    kmAntes: Number.isFinite(kmAntes) ? kmAntes : null,
    kml: (Number.isFinite(kml) ? kml : null),
    deltaKm: (Number.isFinite(deltaKm) ? deltaKm : null),
    autonomiaEst: (Number.isFinite(autonomiaEst) ? autonomiaEst : null)
  };

  items.push(item);
  sortItems();
  saveItems(items);

  $("saveStatus").textContent = (item.kml ? `Salvo ‚úÖ Km/L calculado: ${formatNum(item.kml,2)} (Œî ${formatInt(item.deltaKm)} km)` : "Salvo ‚úÖ (Km/L ser√° calculado a partir do 2¬∫ abastecimento do mesmo combust√≠vel)");
  toast("Salvo ‚úÖ");
  setPill("Pronto");

  clearForm(false);
  renderAll();
}

function clearForm(clearNf=false){
  $("odometro").value = "";
  $("litros").value = "";
  $("valor").value = "";
  $("kmAntes").value = "";
  if(clearNf){
    $("nfceLink").value = "";
    $("nfceUrl").value = "";
  }
}
$("btnSalvar").addEventListener("click", saveForm);
$("btnLimparForm").addEventListener("click", ()=>{ clearForm(false); toast("Campos limpos"); });

$("btnApagarTudo").addEventListener("click", ()=>{
  if(!confirm("Apagar TODO o hist√≥rico?")) return;
  items = [];
  saveItems(items);
  renderAll();
  toast("Hist√≥rico apagado");
});

$("btnExportarJson").addEventListener("click", ()=>{
  const payload = { exportedAt: new Date().toISOString(), cfg, items };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `backup_combustivel_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
  toast("Backup baixado");
});

/* =========================
   Config
========================= */
function loadCfgToUI(){
  $("tank").value = (cfg.tank ?? 52);
  $("kmlWindow").value = (cfg.kmlWindow ?? 6);
}
function saveCfgFromUI(){
  const tank = parseBRNumber($("tank").value);
  const kmlWindow = parseBRNumber($("kmlWindow").value);
  if(!Number.isFinite(tank) || tank<=0){ toast("Tanque inv√°lido"); return; }
  if(!Number.isFinite(kmlWindow) || kmlWindow<1){ toast("Janela inv√°lida"); return; }
  cfg.tank = tank;
  cfg.kmlWindow = Math.round(kmlWindow);
  saveCfg(cfg);
  $("cfgStatus").textContent = "Configura√ß√µes salvas ‚úÖ";
  toast("Config salva ‚úÖ");
  renderAll();
}
$("btnSalvarCfg").addEventListener("click", saveCfgFromUI);

/* =========================
   Render (cards, table, charts)
========================= */
function gastoMesAtual(){
  const now = new Date();
  const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
  const sum = items
    .filter(x => ymFromDateISO(x.data)===ym && Number.isFinite(Number(x.valor)))
    .reduce((acc,x)=>acc+Number(x.valor),0);
  return sum;
}
function autonomiaAtual(){
  // prefer√™ncia: usar a √∫ltima autonomiaEst calculada
  const last = [...items].sort((a,b)=>(a.data||"").localeCompare(b.data||"")).slice(-1)[0];
  if(!last) return null;
  if(Number.isFinite(Number(last.autonomiaEst))) return Number(last.autonomiaEst);

  // fallback: tanque * m√©dia geral do tipo do √∫ltimo abastecimento
  const av = avgKml(last.tipo);
  if(!Number.isFinite(av)) return null;
  const tank = Number(cfg.tank) || 52;
  return tank * av;
}

function renderCards(){
  const gas = avgKml("Gasolina");
  const eta = avgKml("Etanol");
  $("kmlGas").textContent = gas ? formatNum(gas,2) : "‚Äî";
  $("kmlEta").textContent = eta ? formatNum(eta,2) : "‚Äî";
  $("gastoMes").textContent = formatBRL(gastoMesAtual());

  const aut = autonomiaAtual();
  $("autonomia").textContent = aut ? `${formatInt(aut)} km` : "‚Äî";
}

function renderTable(){
  const tb = $("tbody");
  tb.innerHTML = "";
  if(items.length===0){
    $("histStatus").textContent = "Sem lan√ßamentos ainda.";
    return;
  }
  const rows = [...items].sort((a,b)=>(b.data||"").localeCompare(a.data||""));
  for(const x of rows){
    const tr = document.createElement("tr");
    const nf = x.nfceLink ? `<a href="${x.nfceLink}" target="_blank" rel="noopener">abrir</a>` : "‚Äî";
    tr.innerHTML = `
      <td>${x.data || "‚Äî"}</td>
      <td>${Number.isFinite(Number(x.odometro)) ? formatInt(x.odometro) : "‚Äî"}</td>
      <td>${Number.isFinite(Number(x.litros)) ? formatNum(x.litros,3) : "‚Äî"}</td>
      <td>${Number.isFinite(Number(x.valor)) ? formatBRL(x.valor) : "‚Äî"}</td>
      <td>${x.tipo || "‚Äî"}</td>
      <td>${Number.isFinite(Number(x.kml)) ? formatNum(x.kml,2) : "‚Äî"}</td>
      <td>${nf}</td>
    `;
    tb.appendChild(tr);
  }
  $("histStatus").textContent = `${items.length} lan√ßamento(s).`;
}

let chartKml = null;
let chartMes = null;

function buildKmlSeries(){
  const rows = [...items].sort((a,b)=>(a.data||"").localeCompare(b.data||""));
  const labels = rows.map(x=>x.data);
  const gas = rows.map(x=>(x.tipo==="Gasolina" && Number.isFinite(Number(x.kml))) ? Number(x.kml) : null);
  const eta = rows.map(x=>(x.tipo==="Etanol" && Number.isFinite(Number(x.kml))) ? Number(x.kml) : null);
  return { labels, gas, eta };
}
function buildMonthlySpend(){
  const map = new Map();
  for(const x of items){
    const ym = ymFromDateISO(x.data);
    if(!ym) continue;
    const v = Number(x.valor);
    if(!Number.isFinite(v)) continue;
    map.set(ym, (map.get(ym)||0)+v);
  }
  const keys = [...map.keys()].sort();
  return { labels: keys.map(ymLabel), values: keys.map(k=>map.get(k)) };
}

function renderCharts(){
  const kml = buildKmlSeries();
  const ms = buildMonthlySpend();

  const ctx1 = document.getElementById("chartKml");
  const ctx2 = document.getElementById("chartMes");

  if(chartKml) chartKml.destroy();
  if(chartMes) chartMes.destroy();

  chartKml = new Chart(ctx1, {
    type:"line",
    data:{
      labels: kml.labels,
      datasets:[
        { label:"Gasolina (Km/L)", data:kml.gas, spanGaps:true, tension:.25 },
        { label:"Etanol (Km/L)", data:kml.eta, spanGaps:true, tension:.25 },
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:true,
      plugins:{ legend:{ labels:{ color:"#eaf1ff" } } },
      scales:{
        x:{ ticks:{ color:"rgba(234,241,255,.75)" }, grid:{ color:"rgba(255,255,255,.06)" } },
        y:{ ticks:{ color:"rgba(234,241,255,.75)" }, grid:{ color:"rgba(255,255,255,.06)" } }
      }
    }
  });

  chartMes = new Chart(ctx2, {
    type:"bar",
    data:{
      labels: ms.labels,
      datasets:[
        { label:"Gasto (R$)", data: ms.values }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:true,
      plugins:{ legend:{ labels:{ color:"#eaf1ff" } } },
      scales:{
        x:{ ticks:{ color:"rgba(234,241,255,.75)" }, grid:{ color:"rgba(255,255,255,.06)" } },
        y:{ ticks:{ color:"rgba(234,241,255,.75)" }, grid:{ color:"rgba(255,255,255,.06)" } }
      }
    }
  });

  $("relStatus").textContent = items.length ? "Atualizado." : "Sem dados para gr√°ficos.";
}

function renderAll(){
  loadCfgToUI();
  renderCards();
  renderTable();
  // charts render only when tab open; but if already open, refresh
  const isRelOpen = document.getElementById("view-relatorios").style.display !== "none";
  if(isRelOpen) renderCharts();
}

/* =========================
   Init
========================= */
(function init(){
  // default date
  const today = new Date();
  $("data").value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;

  $("nfceStatus").textContent = "Cole o link da NFC-e e toque em ‚ÄúLer NFC-e e preencher‚Äù.";
  $("saveStatus").textContent = "‚Äî";
  $("cfgStatus").textContent = "‚Äî";
  $("histStatus").textContent = "‚Äî";
  $("relStatus").textContent = "‚Äî";

  renderAll();
  showView("painel");
})();
</script>
</body>
</html>
