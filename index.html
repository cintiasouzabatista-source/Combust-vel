<!DOCTYPE html>
<title> OlÃ¡, Seja Bem Vindo </title>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle CombustÃ­vel </title>

<style>
  body{
    font-family: Arial, sans-serif;
    background:#0f172a;
    color:white;
    margin:0;
    padding:20px;
  }
  h1{margin:0 0 16px 0; line-height:1.2}
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:15px;
    margin-bottom:20px;
  }
  .card{
    background:#1e293b;
    padding:15px;
    border-radius:14px;
  }
  .row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:10px;
  }
  .row > *{flex:1}
  input,select,button{
    width:100%;
    padding:10px;
    margin-top:8px;
    border-radius:10px;
    border:none;
    outline:none;
    box-sizing:border-box;
  }
  input,select{background:#f8fafc;color:#0f172a}
  button{
    background:#2563eb;
    color:white;
    cursor:pointer;
    font-weight:600;
  }
  button.secondary{background:#334155}
  button.danger{background:#dc2626}
  small{color:#94a3b8; display:block; margin-top:8px}
  video{border-radius:12px}
  .value{font-size:22px; font-weight:800; margin-top:6px}
</style>
</head>

<body>

<h1> Controle CombustÃ­vel </h1>

<div class="grid">
  <div class="card">
    <h3>Km/L Gasolina</h3>
    <div class="value" id="kmlGas">â€”</div>
  </div>
  <div class="card">
    <h3>Km/L Etanol</h3>
    <div class="value" id="kmlEta">â€”</div>
  </div>
  <div class="card">
    <h3>Gasto no mÃªs</h3>
    <div class="value" id="gastoMes">R$ 0,00</div>
  </div>
  <div class="card">
    <h3>Autonomia estimada</h3>
    <div class="value" id="autonomia">â€”</div>
  </div>
</div>

<div class="card">
  <h3>Nota fiscal (NFC-e)</h3>

  <button type="button" onclick="toggleScanner()">ðŸ“· Ler QR da NFC-e</button>
  <video id="qrVideo" style="display:none;width:100%;margin-top:10px" playsinline></video>

  <input id="nfceUrl" placeholder="Cole aqui o link da NFC-e (ConsultaQRCode.aspx?p=...)" />
  <button type="button" onclick="lerNfce()">âœ… Ler NFC-e e preencher</button>

  <small id="nfceStatus">â€”</small>
</div>

<div class="card">
  <h3>Novo abastecimento</h3>

  <input type="date" id="data">
  <input type="number" id="odometro" placeholder="OdÃ´metro (km)">
  <input type="number" id="litros" placeholder="Litros">
  <input type="number" id="valor" placeholder="Valor (R$)">
  <select id="tipo">
    <option>Gasolina</option>
    <option>Etanol</option>
  </select>

  <div class="row">
    <button type="button" onclick="salvar()">Salvar</button>
    <button type="button" class="secondary" onclick="limparCampos()">Limpar</button>
  </div>

  <div class="row">
    <button type="button" class="danger" onclick="resetar()">ðŸ§¹ Apagar tudo</button>
  </div>

  <small id="status">â€”</small>
</div>

<script>
  // ====== DADOS ======
  let abastecimentos = JSON.parse(localStorage.getItem("abastecimentos") || "[]");

  // ====== HELPERS ======
  const brMoney = (n) => {
    const v = Number(n || 0);
    return v.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
  };

  function setStatus(msg){
    document.getElementById("status").innerText = msg;
  }
  function setNfceStatus(msg){
    document.getElementById("nfceStatus").innerText = msg;
  }

  function limparCampos(){
    document.getElementById("nfceUrl").value = "";
    document.getElementById("data").value = "";
    document.getElementById("odometro").value = "";
    document.getElementById("litros").value = "";
    document.getElementById("valor").value = "";
    document.getElementById("tipo").value = "Gasolina";
    setStatus("Campos limpos.");
    setNfceStatus("â€”");
  }

  function resetar(){
    if(confirm("Apagar todos os abastecimentos salvos?")){
      localStorage.removeItem("abastecimentos");
      abastecimentos = [];
      atualizar();
      setStatus("Zerado! Nenhum lanÃ§amento salvo.");
    }
  }

  // ====== SALVAR ======
  function salvar(){
    const data = document.getElementById("data").value;
    const odometro = Number(document.getElementById("odometro").value);
    const litros = Number(document.getElementById("litros").value);
    const valor = Number(document.getElementById("valor").value);
    const tipo = document.getElementById("tipo").value;

    if(!data || !odometro || !litros || !valor){
      setStatus("Preencha data, odÃ´metro, litros e valor.");
      return;
    }

    const item = { data, odometro, litros, valor, tipo };

    abastecimentos.push(item);

    // manter em ordem por data/odÃ´metro (evita bagunÃ§a)
    abastecimentos.sort((a,b)=> (a.odometro - b.odometro));

    localStorage.setItem("abastecimentos", JSON.stringify(abastecimentos));
    atualizar();
    setStatus("Salvo âœ…");
  }

  // ====== DASHBOARD ======
  function atualizar(){
    // gasto do mÃªs (sempre dÃ¡ pra calcular)
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();

    const gasto = abastecimentos
      .filter(a => {
        const d = new Date(a.data + "T00:00:00");
        return d.getMonth() === mesAtual && d.getFullYear() === anoAtual;
      })
      .reduce((s,a)=> s + Number(a.valor || 0), 0);

    document.getElementById("gastoMes").innerText = brMoney(gasto);

    // Km/L e autonomia sÃ³ com pelo menos 2 registros vÃ¡lidos
    if(abastecimentos.length < 2){
      document.getElementById("kmlGas").innerText = "â€”";
      document.getElementById("kmlEta").innerText = "â€”";
      document.getElementById("autonomia").innerText = "â€”";
      return;
    }

    let gas = [];
    let eta = [];

    for(let i=1; i<abastecimentos.length; i++){
      const atual = abastecimentos[i];
      const anterior = abastecimentos[i-1];

      const km = (atual.odometro - anterior.odometro);
      if(km <= 0) continue;          // odÃ´metro invÃ¡lido
      if(atual.litros <= 0) continue;

      const consumo = km / atual.litros;  // km/l
      if(atual.tipo === "Gasolina") gas.push(consumo);
      else eta.push(consumo);
    }

    const media = (arr) => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : null;

    const mg = media(gas);
    const me = media(eta);

    document.getElementById("kmlGas").innerText = (mg ? mg.toFixed(2) : "â€”");
    document.getElementById("kmlEta").innerText = (me ? me.toFixed(2) : "â€”");

    // autonomia estimada (tanque 52L como padrÃ£o)
    const tanque = 52;
    if(mg){
      document.getElementById("autonomia").innerText = Math.round(mg * tanque) + " km";
    }else if(me){
      document.getElementById("autonomia").innerText = Math.round(me * tanque) + " km";
    }else{
      document.getElementById("autonomia").innerText = "â€”";
    }
  }

  // ====== NFC-e (colar link + QR) ======
  function preencherCampos(n){
    // dataHora: "25/02/2026 18:15:50" -> "2026-02-25"
    if(n.dataHora){
      const d = n.dataHora.split(" ")[0];
      const [dd,mm,aaaa] = d.split("/");
      document.getElementById("data").value = `${aaaa}-${mm}-${dd}`;
    }
    if(n.litros != null) document.getElementById("litros").value = n.litros;
    if(n.valor != null) document.getElementById("valor").value = n.valor;
    if(n.tipo) document.getElementById("tipo").value = n.tipo;
  }

  async function lerNfce(){
    const url = (document.getElementById("nfceUrl").value || "").trim();
    if(!url){
      setNfceStatus("Cole o link da NFC-e primeiro.");
      return;
    }

    setNfceStatus("Lendo NFC-eâ€¦");

    try{
      const apiUrl = "/api/nfce?url=" + encodeURIComponent(url);
      const r = await fetch(apiUrl);
      const j = await r.json();

      if(!j.ok){
        setNfceStatus("Erro: " + (j.error || "nÃ£o consegui ler a NFC-e"));
        return;
      }

      preencherCampos(j.normalized || {});
      setNfceStatus(`OK âœ… ${j.normalized?.tipo || "-"} â€¢ ${brMoney(j.normalized?.valor)} â€¢ ${j.normalized?.litros ?? "-"} L`);
    }catch(e){
      setNfceStatus("Falha ao chamar a API.");
    }
  }

  // ====== QR Scanner (nativo) ======
  let qrStream = null;

  async function toggleScanner(){
    const video = document.getElementById("qrVideo");

    // se jÃ¡ estiver aberto, fecha
    if(qrStream){
      qrStream.getTracks().forEach(t=>t.stop());
      qrStream = null;
      video.style.display = "none";
      setNfceStatus("Scanner fechado.");
      return;
    }

    // abre cÃ¢mera
    try{
      qrStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = qrStream;
      await video.play();
      video.style.display = "block";
      setNfceStatus("Aponte para o QR da NFC-eâ€¦");

      if(!("BarcodeDetector" in window)){
        setNfceStatus("Seu navegador nÃ£o suporta leitura nativa de QR. Use 'colar link' por enquanto.");
        return;
      }

      const detector = new BarcodeDetector({ formats: ["qr_code"] });

      const scanLoop = async () => {
        if(!qrStream) return;

        try{
          const codes = await detector.detect(video);
          if(codes && codes.length){
            const raw = (codes[0].rawValue || "").trim();

            // fecha cÃ¢mera
            qrStream.getTracks().forEach(t=>t.stop());
            qrStream = null;
            video.style.display = "none";

            document.getElementById("nfceUrl").value = raw;
            setNfceStatus("QR lido! Buscando dadosâ€¦");
            await lerNfce();
            return;
          }
        }catch(e){}

        requestAnimationFrame(scanLoop);
      };

      scanLoop();
    }catch(e){
      setNfceStatus("NÃ£o consegui abrir a cÃ¢mera (permissÃ£o negada ou sem cÃ¢mera).");
    }
  }

  // inicializa
  atualizar();
  setStatus(abastecimentos.length ? `VocÃª tem ${abastecimentos.length} lanÃ§amento(s) salvo(s).` : "Nenhum lanÃ§amento salvo ainda.");

</script>

</body>
</html>
