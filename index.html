<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Combust√≠vel - Fiesta</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf"></script>

<style>
body{
    font-family: Arial;
    background:#0f172a;
    color:#fff;
    margin:0;
    padding:15px;
}
h1{font-size:18px}
.card{
    background:#1e293b;
    padding:15px;
    border-radius:15px;
    margin-bottom:15px;
}
input, select, button{
    width:100%;
    padding:10px;
    margin-top:5px;
    border-radius:10px;
    border:none;
}
button{
    background:#3b82f6;
    color:white;
    font-weight:bold;
}
.grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
    gap:10px;
}
.big{font-size:18px;font-weight:bold}
small{color:#94a3b8}
canvas{background:white;border-radius:10px;padding:5px}
</style>
</head>

<body>

<h1>üöó Controle Combust√≠vel - Ford Fiesta</h1>

<div class="grid">
<div class="card">
<div class="big" id="mediaGas">--</div>
<small>Km/L Gasolina</small>
</div>

<div class="card">
<div class="big" id="mediaEta">--</div>
<small>Km/L Etanol</small>
</div>

<div class="card">
<div class="big" id="gastoMes">--</div>
<small>Gasto no m√™s</small>
</div>

<div class="card">
<div class="big" id="autonomia">--</div>
<small>Autonomia estimada</small>
</div>
</div>

<div class="card">
<h3>Novo abastecimento</h3>
<input type="date" id="data">
<input type="number" id="km" placeholder="Od√¥metro (km)">
<input type="number" id="litros" placeholder="Litros">
<input type="number" id="valor" placeholder="Valor (R$)">
<select id="tipo">
<option>Gasolina</option>
<option>Etanol</option>
</select>
<button onclick="salvar()">Salvar</button>
</div>

<div class="card">
<h3>Configura√ß√£o Tanque</h3>
<input type="number" id="tanque" placeholder="Capacidade do tanque (ex: 52)">
<input type="number" id="odometroAtual" placeholder="Od√¥metro atual">
<button onclick="salvarConfig()">Salvar Configura√ß√£o</button>
</div>

<div class="card">
<canvas id="grafico"></canvas>
</div>

<div class="card">
<button onclick="exportarExcel()">Exportar Excel</button>
<button onclick="exportarPDF()">Exportar PDF</button>
</div>

<script>
let dados = JSON.parse(localStorage.getItem("combustivel")) || [];
let config = JSON.parse(localStorage.getItem("config")) || {tanque:52};

document.getElementById("tanque").value=config.tanque;

function salvar(){
    let novo = {
        data:document.getElementById("data").value,
        km:Number(document.getElementById("km").value),
        litros:Number(document.getElementById("litros").value),
        valor:Number(document.getElementById("valor").value),
        tipo:document.getElementById("tipo").value
    };
    dados.push(novo);
    localStorage.setItem("combustivel",JSON.stringify(dados));
    atualizar();
}

function salvarConfig(){
    config.tanque=Number(document.getElementById("tanque").value);
    localStorage.setItem("config",JSON.stringify(config));
    atualizar();
}

function atualizar(){
    if(dados.length<2) return;

    let gas=[], eta=[];
    for(let i=1;i<dados.length;i++){
        let kmRodado=dados[i].km-dados[i-1].km;
        let consumo=kmRodado/dados[i].litros;
        if(dados[i].tipo=="Gasolina") gas.push(consumo);
        if(dados[i].tipo=="Etanol") eta.push(consumo);
    }

    let mediaGas = gas.length? (gas.reduce((a,b)=>a+b)/gas.length):0;
    let mediaEta = eta.length? (eta.reduce((a,b)=>a+b)/eta.length):0;

    document.getElementById("mediaGas").innerText=mediaGas.toFixed(2)+" km/L";
    document.getElementById("mediaEta").innerText=mediaEta.toFixed(2)+" km/L";

    let mesAtual=new Date().getMonth();
    let totalMes=dados.filter(d=>new Date(d.data).getMonth()==mesAtual)
        .reduce((a,b)=>a+b.valor,0);
    document.getElementById("gastoMes").innerText="R$ "+totalMes.toFixed(2);

    let ultima=dados[dados.length-1];
    let odometroAtual=Number(document.getElementById("odometroAtual").value)||ultima.km;
    let kmDesde=odometroAtual-ultima.km;
    let consumoRef=ultima.tipo=="Gasolina"?mediaGas:mediaEta;
    let autonomiaRest=(config.tanque-(kmDesde/consumoRef))*consumoRef;

    document.getElementById("autonomia").innerText=autonomiaRest.toFixed(0)+" km";

    criarGrafico(gas,eta);
}

let chart;
function criarGrafico(gas,eta){
    let ctx=document.getElementById("grafico").getContext("2d");
    if(chart) chart.destroy();
    chart=new Chart(ctx,{
        type:"bar",
        data:{
            labels:["Gasolina","Etanol"],
            datasets:[{
                label:"Km/L m√©dio",
                data:[
                    gas.length?gas.reduce((a,b)=>a+b)/gas.length:0,
                    eta.length?eta.reduce((a,b)=>a+b)/eta.length:0
                ]
            }]
        }
    });
}

function exportarExcel(){
    let wb=XLSX.utils.book_new();
    let ws=XLSX.utils.json_to_sheet(dados);
    XLSX.utils.book_append_sheet(wb,ws,"Abastecimentos");
    XLSX.writeFile(wb,"relatorio.xlsx");
}

function exportarPDF(){
    let doc=new jspdf.jsPDF();
    doc.text("Relat√≥rio Combust√≠vel",20,20);
    doc.text("Total registros: "+dados.length,20,30);
    doc.save("relatorio.pdf");
}

atualizar();
</script>

</body>
</html>
